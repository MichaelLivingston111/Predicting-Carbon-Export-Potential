---
title: "Model_Visualization"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Load required packages:
```{r}


suppressMessages(library(ggplot2))
suppressMessages(library(caret))
suppressMessages(library(ggpubr))
suppressMessages(library(MuMIn))
suppressMessages(library(lme4))
suppressMessages(library(feather))
suppressMessages(library(arrow))
suppressMessages(library(dplyr))
suppressMessages(library(viridis))
suppressMessages(library(scatterplot3d))
suppressMessages(library(graph3d))
suppressMessages(library(plot3D))
suppressMessages(library(magrittr))

```


# Load the data:
```{r}

# Upload the data from a total data file:
total_data <- read.csv("MODEL_DATA.csv")

# Input required files into function:
regional_data <- Read_fn("MODEL_DATA.csv")  # Regional
global_data <- Read_fn("MODEL_DATA_GLOBAL.csv")  # Global



```


# Make a basic 3D visualization between the most important parameters:
```{r}

scatterplot3d(x = global_data$Log_Chl, y = global_data$Temperature, z = global_data$TEP, pch = 16,
              xlab = "Chlorophyll a (log-scale)", ylab = "Temperature (˚C)", zlab = "TEP")


```

# Visualize a multivariate regression with Temperature + Chl on the above plot:
```{r}

#colors <- c("red", "black")
#colors <- colors(global_data$Bloom)

SP3D <- scatterplot3d(x = global_data$Log_Chl, y = global_data$Temperature, z = global_data$TEP, pch = 16,
              xlab = "Chlorophyll a (log-scale)", ylab = "Temperature (˚C)", zlab = "TEP",
              angle = 45)  # type = 'h' will add vertical line points

# Add regression plane
my.lm <- lm(global_data$TEP ~ global_data$Log_Chl + global_data$Temperature)
SP3D$plane3d(my.lm, draw_polygon = FALSE, draw_lines = TRUE, lty.box = 'solid')

# Legend
#legend("right", legend = levels(as.numeric(global_data$Bloom)),
      #col =  c("red", "black"), pch = 16)



```


```{r}

csbaPal = c("#16325B", "#0072B4", "#00B0E0", "#007236", "#00AE62",
            "#8FB063", "#9D0817", "#4A0C61", "#6E60AA", "#AB9F3")

scatter3D(x = global_data$Log_Chl, y = global_data$Temperature, 
            z = global_data$TEP, col = ramp.col(csbaPal[2:5]))

# Create grid matrix of predictions
grid.lines = 26 # vis parameter

x.pred = seq(min(global_data$Log_Chl), 
             max(global_data$Log_Chl), length.out= grid.lines)
y.pred = seq(min(global_data$Temperature), 
             max(global_data$Temperature), length.out = grid.lines)
xy = expand.grid(Log_Chl = x.pred, 
                 Temperature = y.pred)

z.pred = matrix(predict(my.lm, newdata = xy), 
                nrow = grid.lines, ncol = grid.lines)

fitpoints = predict(my.lm)


scatter3D(x = Log_Chl, y = Temperature, z = TEP,
          pch = 18, cex = 2, theta = 20, phi = 20, ticktype = "detailed",
                     surf = list(x = x.pred, y = y.pred, z = z.pred,
                                 facets = NA, fit = fitpoints))


```

```{r}

# Create the model:
global_data %>% lm(TEP ~ Log_Chl + Temperature, data = .) -> fit

grid.lines = 16 #vis parameter

x.pred = seq(min(global_data$Log_Chl), 
             max(global_data$Log_Chl), length.out= grid.lines)
y.pred = seq(min(global_data$Temperature), 
             max(global_data$Temperature), length.out = grid.lines)
xy = expand.grid(Log_Chl = x.pred, 
                 Temperature = y.pred)

z.pred = matrix(predict(fit, newdata = xy), 
                nrow = grid.lines, ncol = grid.lines)

fitpoints = predict(fit)

global_data %$% scatter3D(Log_Chl, Temperature, TEP, pch = 18, cex = 1,
                     theta = 45, phi = 25, ticktype = "detailed",
                     surf = list(x = x.pred, y = y.pred, z = z.pred,
                                 facets = NA, fit = fitpoints),
                     xlab = "Chlorophyll a (log-scaled)", 
                     ylab = "Temperature (˚C)", zlab = "TEP",
                     bty = 'g')


```


# Reconfirm validity of temperature influence with bloom as a factor:
```{r}

ggplot(global_data, aes(Temperature, TEP, colour = as.factor(Bloom))) + 
  geom_point() +
  geom_smooth(method = 'lm')


summary(lm(TEP ~ Temperature + Bloom, data = global_data))



```

